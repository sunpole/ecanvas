<!-- CHANGLOG MODAL START -->
<div class="modal-changelog" id="modalChangelog" tabindex="-1" aria-hidden="true">
<!-- Анимированный фон -->
<div class="modal-changelog-bg" aria-hidden="true">
  <canvas id="modalChangelogBgCanvas" style="display:block;position:absolute;inset:0;width:100%;height:100%;pointer-events:none;"></canvas>
</div>
  <div class="modal-changelog-dialog">
    <div class="modal-changelog-header">
      <div class="modal-changelog-title">История изменений</div>
      <nav class="changelog-nav">
        <a href="#v1-1-5" class="changelog-nav-link">1.1.5</a>
        <a href="#v1-1-4" class="changelog-nav-link">1.1.4</a>
        <a href="#v1-1-3" class="changelog-nav-link">1.1.3</a>
        <a href="#v1-1-2" class="changelog-nav-link">1.1.2</a>
        <a href="#v1-1-1-2" class="changelog-nav-link">1.1.1.2</a>
        <a href="#v1-1-1" class="changelog-nav-link">1.1.1</a>
        <a href="#v1-1-0" class="changelog-nav-link">1.1.0</a>
        <a href="#v1-0-7" class="changelog-nav-link">1.0.7</a>
        <a href="#v1-0-6" class="changelog-nav-link">1.0.6</a>
      </nav>
      <button class="close-btn" id="closeChangelog">СПАСИБО ЗА ВНИМАНИЕ</button>
    </div>
    <div class="modal-changelog-body" id="changelogBody">
<pre>
<h3 id="v1-1-5">Версия 1.1.5 (08.06.2025)</h3>
- Выполнено слияние изменений веток 1.1.2 и 1.1.3 — теперь весь актуальный функционал доступен в единой версии 1.1.5.
- Ветка 1.1.4 удалена как промежуточная и более не поддерживается.

<strong>Масштабирование игрового поля:</strong>
- Исправлена логика вычисления размера canvas: поле всегда строго квадратное и максимально большое независимо от устройства и ориентации.
- На ПК и планшетах игровое поле стало заметно крупнее — занимает до 96% доступной области.
- На мобильных исправлены смещения: клетка под пальцем всегда корректно выделяется при нажатии.
- <strong>Для ПК с альбомной ориентацией игровое поле всё ещё очень мелкое — будет производиться поиск прошлых версий и решений, чтобы сделать canvas удобным для ПК.</strong>

<strong>Единый стиль canvas:</strong>
- Отменено раздельное определение размеров в портретной/альбомной ориентации — для всех устройств применяется единый алгоритм максимального квадрата.
- В CSS canvas ограничен только max-width и max-height, все размеры теперь задаются через JS.

<strong>Улучшена отзывчивость интерфейса:</strong>
- Баланс отступов и размеров минимального поля улучшен для максимального удобства.
- Усилена защитная обработка resize и orientationchange — быстрее и стабильнее реагирует на смену ориентации, особенно на мобильниках и планшетах.

<strong>Рефакторинг и очистка кода:</strong>
- Удалены все устаревшие и избыточные части, связанные с 1.1.4.
- Упрощён расчет ячейки при кликах/касаниях — теперь одинаково работает на любых DPI и устройствах.

<strong>Итог:</strong>
- Версия 1.1.5 — универсальный релиз "Game Grid" для любых экранов. Сохранён весь функционал прошлых версий, исправлены баги с размером и выбором клеток.

<div class="changelog-error">
<h3 id="v1-1-4">Версия 1.1.4</h3>
- Размер поля теперь рассчитывается по большей части доступной высоты или ширины экрана — с небольшим запасом (-40), чтобы визуально не прилипать к краям.
- Минимальный размер поля увеличен до 420px (ранее был меньше).
- В CSS для ПК установлены ограничения: `max-width: 98vw !important;` и `max-height: 96vh !important;` — позволяет растягивать окно почти на весь экран.
</div>
  
<h3 id="v1-1-3">Версия 1.1.3</h3>
- Добавлен визуальный индикатор активного медиазапроса (breakpoint) рядом с "Инфо-панель". Теперь всегда видно, на каком режиме работает верстка: ПК (альбомный/книжный), планшет или мобильник (альбомный/книжный).
- Для индикатора разработан отдельный стиль: тёмно-серый цвет, тонкая рамка, скругления, аккуратная непрозрачность — вписывается в верхнюю панель, не мешает контенту.
- В JavaScript реализована функция updateMediaIndicator для автоматического обновления состояния индикатора при любых изменениях размера окна или ориентации устройства.
- Переработан breakpoint desktop: теперь включается уже с ширины 900px (раньше было с 1025px). Это обеспечивает нормальный десктопный вид даже на небольших ноутбуках и 13" экранах.
- Улучшено удобство тестирования и визуального контроля адаптивности: при изменении ширины или положения экрана название активного режима меняется мгновенно и наглядно прямо в интерфейсе.

<h3 id="v1-1-2">Версия 1.1.2</h3>
- При клике по DEV ― модалка открывается, при повторном ― закрывается.
- Логируется открытие/закрытие/инициализация/якоря в консоль.
- Помимо внутреннего Esc (в модалке), глобальный Esc на всей странице тоже закрывает, если она видима (даже если вдруг фокус ушёл).
- Навес listener'ы внутри модалки только единожды (data-inited).
- Всё и по UX, и по DX теперь надёжно и проверяемо!
  
<h3 id="v1-1-1-2">Версия 1.1.1.2</h3>
– Модалка автоматически наследует тему.
– Кнопка "DEV" — видна всегда, выдвинута поверх, всегда контрастная для любой темы.
– Код оптимизирован для мобильных/десктопов.
– Всё разметка и стили структурированы строго и валидно.
– Модалка подгружается только при первом клике (через fetch), нет дублированных стилей/разметки.
– Важно: рядом с этим файлом должен лежать changelog-modal.html — тот самый, который ты делал ранее.
– Весь функционал и стили modal и кнопки вынесены в один чистый файл.

<h3 id="v1-1-1">Версия 1.1.1</h3>
— Поддержка светлой и тёмной темы, автоподстройка по системе, кнопка переключения темы
— Вся гамма завернута в CSS-переменные
— Оптимизация адаптивности для мобильных, планшетов и ПК
— Цветовые улучшения для канваса и интерфейса
— Стартовые ссылки для changelog-якорей в модалке

<h3 id="v1-1-0">Версия 1.1.0</h3>
— Горизонтальные панели на планшетах и в landscape на мобильном
— Безопасные поля со всех краёв
– Исправлен стиль под большие экранные устройства.
– Для ПК и ноутбуков возвращены классические верх и низ для панелей, масштаб поля смотрится естественно и современно.
– Мобильная и планшетная версия адаптивны (безопасные края, responsive канвас, панели по бокам в альбомной).

<h3 id="v1-0-7">Версия 1.0.7</h3>
– Используется 100dvh (динамическая высота), а не “устаревшие” 100vh/window.innerHeight;
– Учитывается env(safe-area-inset-bottom) – ВСЕГДА видно подвал даже если system bar перекрывает его;
– Нет прокрутки, вся игра реально полностью на экране;
– Всё реагирует даже на смену ориентации, появление/скрытие строк;
– Готово для реального мобильного PWA-применения.
— Базовая сетка игрового поля
— Фиксы подвалов

<h3 id="v1-0-6">Версия 1.0.6</h3>
– Вертикальной прокрутки не будет — всё полностью влезает ровно на высоту видимой области экрана.
– На мобильном поле, панели и будущий магазин/кнопки всегда на своих местах.
– Страница идеально подходит для мобильной SPA-игры/приложения.

</pre>
    </div>
  </div>
</div>

<style>
:root {
  --modal-bg: #fff;
  --modal-fg: #222;
  --modal-header-bg: #f6f7f9;
  --modal-header-border: #dadcdf;
  --modal-link: #20539f;
  --modal-link-bg: #d9e8fa;
  --modal-link-hover-bg: #b4cfed;
  --modal-link-hover: #11336b;
  --modal-shadow: #162e4a2e;
  --modal-overlay: rgba(24,27,33,.82);
}
html[data-theme='dark'] {
  --modal-bg: #21222b;
  --modal-fg: #e4e8ef;
  --modal-header-bg: #171821;
  --modal-header-border: #31323e;
  --modal-link: #9bbde7;
  --modal-link-bg: #232e40;
  --modal-link-hover-bg: #262d38;
  --modal-link-hover: #bad8ff;
  --modal-shadow: #000d;
  --modal-overlay: rgba(19,21,28,0.87);
}

/* --- Анимированный фон --- */
.modal-changelog-bg {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  animation: bgFadeIn 0.5s ease;
  background: transparent;
}

#modalChangelogBgCanvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: block;
  pointer-events: none;
  background: transparent !important;
}

@keyframes bgFadeIn {
  from { opacity: 0;}
  to {opacity: 1;}
}

.changelog-error {
  animation: error-glow-bg 2s infinite alternate;
  color: #fff;
  border-radius: 8px;
  padding: 1em 1.3em;
  margin: 1.4em 0;
  border: 1.5px solid #c93030;
}

.changelog-error h3 {
  animation: error-glow-text 2s infinite alternate;
  color: #fff;
}

@keyframes error-glow-bg {
  0%   { background: #331112; }
  100% { background: #ff1818; }
}
@keyframes error-glow-text {
  0%   { color: #a11111; text-shadow: 0 0 0px #ff5656;}
  100% { color: #fff;    text-shadow: 0 0 10px #ff3535, 0 0 18px #ffabab;}
}
  
/* --- MODAL core styles --- */
.modal-changelog {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 4000;
  background: var(--modal-overlay);
  align-items: center;
  justify-content: center;
  overflow: auto;
  opacity: 0;
  transition: opacity 0.33s cubic-bezier(.77,.12,.34,.86);
  will-change: opacity;
}
.modal-changelog[aria-hidden="false"] {
  display: flex;
  opacity: 1;
  animation: modalAppear 0.46s cubic-bezier(.11,1.01,.31,.98);
}
@keyframes modalAppear {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-changelog-dialog {
  background: var(--modal-bg);
  color: var(--modal-fg);
  border-radius: 16px;
  max-width: 95vw;
  width: 430px;
  min-width: 224px;
  box-shadow: 0 8px 38px var(--modal-shadow), 0 1px 4px #232a4833;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-height: 87vh;
  transform: scale(0.98) translateY(12px);
  opacity: .93;
  animation: dialogAppear 0.55s cubic-bezier(.13,.9,.38,1.07);
  will-change: transform, opacity;
}
.modal-changelog[aria-hidden="false"] .modal-changelog-dialog {
  transform: scale(1) translateY(0);
  opacity: 1;
  animation: dialogAppear 0.47s cubic-bezier(.33,1.05,.58,.98);
}
@keyframes dialogAppear {
  from { opacity: 0;  transform: scale(0.98) translateY(24px);}
  60% { opacity: .97; }
  to { opacity: 1;  transform: scale(1) translateY(0);}
}

.modal-changelog-header {
  background: var(--modal-header-bg);
  color: var(--modal-fg);
  border-bottom: 1px solid var(--modal-header-border);
  padding: 15px 20px 12px 22px;
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 1px 8px #0001;
  backdrop-filter: blur(0.5px);
  user-select: none;
}

.modal-changelog-title {
  font-weight: bold;
  font-size: 1.14rem;
  margin-bottom: 8px;
  letter-spacing: 0.01em;
  text-shadow: 0 2px 12px #ffffff0a;
}
.changelog-nav {
  display: flex;
  flex-wrap: wrap;
  gap: .55em;
  margin-bottom: 11px;
}

.changelog-nav-link {
  color: var(--modal-link);
  background: var(--modal-link-bg);
  padding: 3px 10px;
  border-radius: 8px;
  font-size: .95em;
  font-weight: 500;
  text-decoration: none;
  transition: 0.17s;
  box-shadow: 0 1px 5px #0001;
}
.changelog-nav-link:hover,.changelog-nav-link:focus {
  background: var(--modal-link-hover-bg);
  color: var(--modal-link-hover);
  box-shadow:0 2px 7px #3331;
}

.close-btn {
  margin-top: 5px;
  font-family: inherit;
  font-size: 1.02rem;
  color: var(--modal-link);
  padding: 5px 16px;
  background: var(--modal-link-bg);
  border: none;
  border-radius: 9px;
  letter-spacing: 0.07em;
  cursor: pointer;
  align-self: flex-end;
  font-weight: 500;
  transition: background 0.16s, color 0.16s;
  box-shadow: 0 1px 8px #20539f0a;
}
.close-btn:hover, .close-btn:focus {
  background: var(--modal-link-hover-bg);
  color: var(--modal-link-hover);
}

.modal-changelog-body {
  background: var(--modal-bg);
  color: var(--modal-fg);
  overflow-y: auto;
  padding: 16px 17px 20px 19px;
  font-size: 1.01rem;
  line-height: 1.45;
  font-family: inherit, monospace;
  max-height: 56vh;
  min-height: 110px;
  scroll-behavior: smooth;
  transition: background 0.22s, color 0.22s;
  border-bottom-left-radius: 14px;
  border-bottom-right-radius: 14px;
}
.modal-changelog-body pre {
  margin: 0;
  font-family: inherit, monospace;
  font-size: 1.01rem;
  line-height: 1.43;
  white-space: pre-wrap;
}
.modal-changelog-body h3 {
  color: var(--modal-link);
  margin: 1.2em 0 0.3em 0;
  font-size: 1.09em;
  letter-spacing: .01em;
  text-shadow: 0 2px 8px #ffffff12;
  font-weight: bold;
}
/* MOBILE MODAL */
@media (max-width: 800px) {
  .modal-changelog-dialog { width: 98vw; min-width: 0; }
}
</style>

<script>
window.initChangelogModal = function(){
  const modal = document.getElementById('modalChangelog');
  const closeBtn = document.getElementById('closeChangelog');

  // Работа закрытия
  function closeModal() {
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  // Кнопка СПАСИБО
  closeBtn.onclick = closeModal;

  // Клик вне модального окна
  modal.addEventListener('mousedown', function(e){
    if(e.target === modal) closeModal();
  });

  // Закрытие по ESC
  modal.addEventListener('keydown', function(e){
    if(e.key === 'Escape') closeModal();
  });

  // Навигация-якоря
  document.querySelectorAll('.changelog-nav-link').forEach(link=>{
    link.addEventListener('click',function(e){
      e.preventDefault();
      const tgt = document.querySelector(this.hash);
      if(tgt) tgt.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });

  // Автофокус
  setTimeout(()=>modal.focus(),20);
};

// ====== Анимированный фон: звёзды/птички для модалки ======
(function modalDynamicBg(){
  const MAX_PARTICLES_DARK = 13;  // звёзд
  const MAX_PARTICLES_LIGHT = 10; // птичек

  const COLORS_STARS = [
    "rgba(255,255,255,0.93)",
    "rgba(163,223,255,0.7)",
    "rgba(199,229,255,0.8)",
    "rgba(210,255,255,0.6)"
  ];
  const COLORS_BIRDS = [
    "rgba(30,30,30,0.33)",
    "rgba(55,55,55,0.25)",
    "rgba(100,100,100,0.22)",
    "rgba(51,51,51,0.24)"
  ];

  function pickColor(theme,alpha=1) {
    if(theme==='dark')
      return COLORS_STARS[Math.floor(Math.random()*COLORS_STARS.length)];
    else
      // темнее на светлом!
      return COLORS_BIRDS[Math.floor(Math.random()*COLORS_BIRDS.length)].replace(/[\d.]+\)$/g, alpha+")");
  }

  function isDark() {
    return (document.documentElement.getAttribute("data-theme") === "dark");
  }

  function Particle(theme, W, H) {
    this.theme = theme;
    this.reset(W,H, true);
  }
  Particle.prototype.reset = function(W,H,skipAlpha){
    this.x = Math.random() * W;
    this.y = Math.random() * H;
    this.size = 1 + Math.random() * (this.theme=='dark'?2.3:9);
    this.lifetime = 4 + Math.random(); // 4-5 сек
    this.age = 0;
    this.color = pickColor(this.theme,0.5 + Math.random()*0.35);
    this.rotation = Math.random()*Math.PI*2;
    this.fadeIn = 0.35 + Math.random()*0.18; // Доля времени fade-in
    this.fadeOut = 0.25 + Math.random()*0.19; // Доля времени fade-out
    if(skipAlpha!==true) this.alpha = 0;
  };
  Particle.prototype.update = function(dt){
    this.age += dt;
  };
  Particle.prototype.opacity = function() {
    // fade-in
    const fadeInT = this.lifetime * this.fadeIn;
    const fadeOutT = this.lifetime * this.fadeOut;
    if(this.age<fadeInT) return this.age/fadeInT;
    if(this.age>this.lifetime-fadeOutT) return Math.max(0,1-(this.age-(this.lifetime-fadeOutT))/fadeOutT);
    return 1;
  };
  Particle.prototype.dead = function(){return this.age>=this.lifetime;};
  Particle.prototype.draw = function(ctx){
    ctx.save();
    ctx.globalAlpha = 0.17 + 0.83 * this.opacity();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    if(this.theme=='dark'){
      // Звезда — кружок
      ctx.beginPath();
      ctx.arc(0,0,this.size,0,2*Math.PI);
      ctx.fillStyle = this.color;
      ctx.shadowColor = this.color;
      ctx.shadowBlur = 7+8*Math.random();
      ctx.fill();
    } else {
      // "V"-bird
      drawBird(ctx, this.size, this.color);
    }
    ctx.restore();
  };
  function drawBird(ctx, s, color){
    ctx.lineWidth = Math.max(1.3, s/3.3);
    ctx.lineCap = "round";
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(-s,0);
    ctx.quadraticCurveTo(0,s*0.8, s,0);
    ctx.stroke();
    // усилить интенсивность
    ctx.beginPath();
    ctx.moveTo(-s*0.8,-0.65);
    ctx.quadraticCurveTo(0,s*0.42, s*0.8,-0.65);
    ctx.globalAlpha *= 0.8;
    ctx.stroke();
  }
  // ---- MAIN ----
  let particles = [];
  let lastTheme = null;
  let lastW=0, lastH=0;
  function regenParticles(theme,W,H) {
    particles = [];
    let MAX = theme==='dark' ? MAX_PARTICLES_DARK : MAX_PARTICLES_LIGHT;
    for(let i=0;i<MAX;++i) {
      particles.push(new Particle(theme,W,H));
      particles[i].age = Math.random() * particles[i].lifetime; // для пачки в разных фазах
    }
  }

  function draw() {
    const theme = isDark() ? "dark" : "light";
    const canvas = document.getElementById('modalChangelogBgCanvas');
    if(!canvas) return;
    const dpr = window.devicePixelRatio || 1;
    let W = Math.floor(canvas.offsetWidth*dpr), H = Math.floor(canvas.offsetHeight*dpr);
    if(canvas.width!==W||canvas.height!==H){
      canvas.width=W; canvas.height=H;
      lastW=W; lastH=H;
      regenParticles(theme, W, H);
    }
    if(lastTheme!==theme){
      // смена темы — заменить все частицы
      regenParticles(theme,W,H);
      lastTheme=theme;
    }
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,W,H);
    let now = performance.now();
    // Move/draw
    for(let i=0;i<particles.length;++i){
      let p = particles[i];
      p.update(1/60);
      if(p.dead()){
        p.reset(W,H);
      }
      p.draw(ctx);
    }
    requestAnimationFrame(draw);
  }
  // смена темы — regenParticles
  let mql = window.matchMedia('(prefers-color-scheme: dark)');
  mql.addEventListener&&mql.addEventListener('change',()=>{lastTheme=null;});
  document.addEventListener('DOMContentLoaded',()=>setTimeout(draw,100));
  // смена темы через кнопку
  new MutationObserver(()=>{lastTheme=null;}).observe(document.documentElement,{attributes:true,attributeFilter:['data-theme']});
})();
</script>
<!-- CHANGLOG MODAL END -->
