<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Game Grid Test</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #23272e;
      color: #fff;
      font-family: sans-serif;
      height: 100%;
      width: 100%;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100vh;
    }
    .top-panel, .bottom-panel {
      min-height: 48px;
      padding: 12px;
      background: #181b21;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .game-field-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    canvas {
      display: block;
      background: #353c48;
      box-shadow: 0 2px 12px #0008;
      touch-action: manipulation;
      border-radius: 8px;
      /* Принудительно убираем артефакты на мобилках */
      max-width: 98vw;
      max-height: 98vw;
    }
  </style>
</head>
<body>
  <div class="top-panel">Инфо-панель</div>
  <div class="game-field-container">
    <canvas id="game-canvas"></canvas>
  </div>
  <div class="bottom-panel">Навигация/кнопки v1.0.3</div>
  <script>
    // === НАСТРОЙКИ СЕТКИ ===
    const GRID_SIZE = 10;

    // Цвета:
    const FIELD_BG = "#353c48";
    const CELL_BG = "#353c48";
    const CELL_BORDER = "#23272e";
    const SELECT_BG = "#6488f0";

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let selectedCell = null;

    // --- Логгирование ---
    function log(...args) {
      if (window && window.console) console.log(...args);
    }

    // --- Адаптивный сайзинг ---
    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      // Учитываем панели сверху и снизу (2*48+2*12)
      const panelSpace = 2 * (48 + 12);

      // Канвас - квадрат, максимально возможный по меньшей стороне
      let size = Math.min(
        Math.floor((h - panelSpace) * 0.98), // почти вся высота кроме панелей
        Math.floor(w * 0.98)                 // почти вся ширина
      );

      // Важно на всякий случай: минимально 200px (можно меньше если надо)
      size = Math.max(size, 200);

      // Ставим визуальный размер
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';

      // Для retina - логический размер выше
      const dpr = window.devicePixelRatio || 1;
      canvas.width = size * dpr;
      canvas.height = size * dpr;
      // Применяем трансформацию для учета dpr:
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);

      log("[resizeCanvas]", { w, h, size, dpr, canvasCssWidth: canvas.style.width, canvasWidth: canvas.width });

      drawGrid();
    }

    // --- Рисуем сетку ---
    function drawGrid() {
      // size в css-пикселях (так же, как canvas.style.width/height)
      const size = parseFloat(canvas.style.width) || 300;
      ctx.clearRect(0, 0, size, size);
      const cellSize = size / GRID_SIZE;

      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          let x = col * cellSize;
          let y = row * cellSize;
          ctx.fillStyle = selectedCell && selectedCell.row === row && selectedCell.col === col ? SELECT_BG : CELL_BG;
          ctx.fillRect(x, y, cellSize, cellSize);
          ctx.strokeStyle = CELL_BORDER;
          ctx.lineWidth = 1.2;
          ctx.strokeRect(x, y, cellSize, cellSize);
        }
      }
    }

    // --- Клик и тач - координаты в CSS-пикселях ---
    function getCellByCoords(evt) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (evt.touches && evt.touches.length) {
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      } else {
        clientX = evt.clientX;
        clientY = evt.clientY;
      }
      // Без всяких переводов: работаем только с css-пикселями
      let x = clientX - rect.left;
      let y = clientY - rect.top;
      const cellSize = rect.width / GRID_SIZE;

      // ПРОВЕРКА-где нажали в логах:
      log(
        "[getCellByCoords]",
        { clientX, clientY, rect: {...rect}, x, y, cellSize }
      );

      const col = Math.floor(x / cellSize);
      const row = Math.floor(y / cellSize);

      // Для отладки:
      if (
        col < 0 || row < 0 ||
        col >= GRID_SIZE || row >= GRID_SIZE
      ) {
        log("Клик вне сетки!", { row, col, x, y });
        return null;
      }

      log("Определена ячейка", { row, col });
      return {row, col};
    }

    function handleClick(evt) {
      const cell = getCellByCoords(evt);
      selectedCell = cell;
      drawGrid();
      if (cell) {
        log(`Выбрана клетка: [${cell.row}, ${cell.col}]`);
      }
    }

    canvas.addEventListener('click', handleClick);

    canvas.addEventListener('touchstart', (evt) => {
      evt.preventDefault();
      handleClick(evt);
    });

    window.addEventListener('resize', resizeCanvas);

    // --- Инициализация ---
    resizeCanvas();
  </script>
</body>
</html>
