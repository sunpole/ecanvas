<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Game Grid Test</title>
  <style>
    :root {
      /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
      --color-bg: #23272e;
      --color-panel: #181b21;
      --color-panel-alt: #23272e;
      --color-card: #353c48;
      --color-cell: #353c48;
      --color-border: #23272e;
      --color-accent: #6488f0;
      --color-text-main: #fcfcfc;
      --color-text-sub: #b9c6d3;
      --color-link: #8cb3fc;
      --color-link-hover: #5476ac;
    }
    html[data-theme='light'] {
      --color-bg: #f6f7f9;
      --color-panel: #f0f1f5;
      --color-panel-alt: #e4eaf2;
      --color-card: #eaf1fa;
      --color-cell: #eaf1fa;
      --color-border: #bdd1e5;
      --color-accent: #20539f;
      --color-text-main: #20222a;
      --color-text-sub: #384049;
      --color-link: #1951a5;
      --color-link-hover: #11336b;
    }
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: var(--color-bg);
      color: var(--color-text-main);
      font-family: system-ui, sans-serif;
      overscroll-behavior: none;
      transition: background 0.2s, color 0.2s;
    }
    body, .main-wrapper {
      height: 100dvh;
      width: 100vw;
      min-height: 100dvh;
      min-width: 100vw;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    .main-wrapper {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
      min-width: 0;
      height: 100dvh;
      width: 100vw;
    }

    .top-panel, .bottom-panel {
      background: var(--color-panel);
      color: var(--color-text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      z-index: 1;
      border-radius: 0;
      box-sizing: border-box;
      transition: background 0.2s, color 0.2s;
    }
    .top-panel {
      min-height: 48px;
      padding: 12px 0 12px env(safe-area-inset-left,0), 12px 0 12px env(safe-area-inset-right,0);
      border-top-left-radius: 0.7rem;
      border-top-right-radius: 0.7rem;
      margin-bottom: 0;
    }
    .bottom-panel {
      min-height: 90px;
      padding: 12px 0 env(safe-area-inset-bottom, 0) 0;
      border-bottom-left-radius: 0.7rem;
      border-bottom-right-radius: 0.7rem;
      margin-top: 0;
    }
    .theme-toggle {
      margin-left: 1rem;
      padding: 4px 16px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      color: var(--color-text-main);
      background: var(--color-panel-alt);
      box-shadow: 0 2px 12px #0002;
      transition: background 0.2s, color 0.2s;
    }
    .theme-toggle:active {
      background: var(--color-accent);
      color: #fff;
    }

    .game-field-container {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      min-width: 0;
      position: relative;
    }
    canvas {
      display: block;
      background: var(--color-card);
      box-shadow: 0 2px 12px #0008;
      touch-action: manipulation;
      border-radius: 8px;
      margin: 0 auto;
      max-width: 92vw;     /* –±–µ–∑–æ–ø–∞—Å–Ω–æ! */
      max-height: 70vh;
      width: 100%;
      height: auto;
      box-sizing: border-box;
      transition: background 0.2s;
      /* –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –≤—ã—Å–æ—Ç—É */
    }
    a {
      color: var(--color-link);
      text-decoration: underline;
      transition: color 0.2s;
    }
    a:hover, a:focus {
      color: var(--color-link-hover);
      filter: brightness(0.85);
    }

    /* --- –ü–ö –∏ –Ω–æ—É—Ç–±—É–∫–∏ —à–∏—Ä–µ 1025 --- */
    @media (orientation: landscape) and (min-width: 1025px) {
      body, .main-wrapper {
        flex-direction: column;
      }
      .main-wrapper {
        flex-direction: column;
        align-items: stretch;
      }
      .top-panel, .bottom-panel {
        min-width: 0;
        width: 100%;
        min-height: 48px;
        height: auto;
        max-width: 100%;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        writing-mode: initial;
        border-radius: 0;
        margin: 0;
        padding: 12px 0;
      }
      .game-field-container {
        flex: 1 1 auto;
        min-height: 0;
        min-width: 0;
        max-height: 92vh;
        align-items: center;
        justify-content: center;
      }
      canvas {
        max-width: 60vh;
        max-height: 80vh;
        margin: 0 auto;
        border-radius: 8px;
      }
    }
    /* --- –ú–æ–±–∏–ª—å–Ω–∞—è –∏ –ø–ª–∞–Ω—à–µ—Ç–Ω–∞—è –∞–ª—å–±–æ–º–Ω–∞—è ( landscape, –¥–æ 1024px) --- */
    @media (orientation: landscape) and (max-width: 1024px) {
      body, .main-wrapper {
        flex-direction: row;
      }
      .main-wrapper {
        flex-direction: row;
        align-items: stretch;
      }
      .top-panel, .bottom-panel {
        width: 56px;
        min-width: 56px;
        max-width: 22vw;
        min-height: 0;
        height: auto;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1;
        border-radius: 0.7rem;
      }
      .top-panel {
        writing-mode: vertical-lr;
        border-top-left-radius: 0.7rem;
        border-bottom-left-radius: 0.7rem;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        margin: 0;
        padding: env(safe-area-inset-top,0) 0 0 env(safe-area-inset-left,0);
      }
      .bottom-panel {
        writing-mode: vertical-lr;
        border-top-right-radius: 0.7rem;
        border-bottom-right-radius: 0.7rem;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        margin: 0;
        padding: 0 0 0 env(safe-area-inset-right,0);
      }
      .game-field-container {
        flex: 1 1 auto;
        min-height: 0;
        min-width: 0;
        max-height: 92vh;    /* –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞! */
        align-items: center;
        justify-content: center;
      }
      canvas {
        max-height: 92vh;
        max-width: 70vw;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="top-panel">
      –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å
      <button class="theme-toggle" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåó</button>
    </div>
    <div class="game-field-container">
      <canvas id="game-canvas"></canvas>
    </div>
    <div class="bottom-panel">
      –ù–∞–≤–∏–≥–∞—Ü–∏—è/–∫–Ω–æ–ø–∫–∏ v1.1.1
    </div>
  </div>
  <script>
    // Theme logic
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('site-theme', theme);
    }
    function getPreferredTheme() {
      return localStorage.getItem('site-theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    }
    document.addEventListener('DOMContentLoaded', () => {
      // Set theme on load
      setTheme(getPreferredTheme());

      // Toggle handler
      const btn = document.getElementById('themeToggle');
      btn.addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        setTheme(isDark ? 'light' : 'dark');
      });

      // Auto-switch on OS theme
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('site-theme')) setTheme(e.matches ? 'dark' : 'light');
      });
    });

    // Game logic
    const GRID_SIZE = 10;
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let selectedCell = null;

    function isLandscape() {
      return window.matchMedia("(orientation: landscape)").matches;
    }

    function getPanelsSize() {
      const topPanel = document.querySelector('.top-panel');
      const bottomPanel = document.querySelector('.bottom-panel');
      if (!isLandscape()) {
        return {
          main: (topPanel ? topPanel.getBoundingClientRect().height : 0)
              + (bottomPanel ? bottomPanel.getBoundingClientRect().height : 0)
        }
      } else {
        return {
          main: (topPanel ? topPanel.getBoundingClientRect().width : 0)
              + (bottomPanel ? bottomPanel.getBoundingClientRect().width : 0)
        }
      }
    }

    function getColors() {
      // –î–ª—è canvas-–∫–æ–Ω—Å—Ç–∞–Ω—Ç
      const root = getComputedStyle(document.documentElement);
      return {
        FIELD_BG: root.getPropertyValue('--color-card').trim(),
        CELL_BG: root.getPropertyValue('--color-cell').trim(),
        CELL_BORDER: root.getPropertyValue('--color-border').trim(),
        SELECT_BG: root.getPropertyValue('--color-accent').trim()
      }
    }

    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      const panels = getPanelsSize();
      const isLand = isLandscape();
      let maxSize;
      if (!isLand) {
        maxSize = Math.min(
          Math.floor(h - panels.main),
          Math.floor(w * 0.92)
        );
      } else {
        maxSize = Math.min(
          Math.floor(h * 0.92),
          Math.floor(w - panels.main)
        );
      }
      maxSize = Math.max(maxSize, 200);

      canvas.style.width = maxSize + 'px';
      canvas.style.height = maxSize + 'px';

      const dpr = window.devicePixelRatio || 1;
      canvas.width = maxSize * dpr;
      canvas.height = maxSize * dpr;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(dpr, dpr);

      drawGrid();
    }

    function drawGrid() {
      const size = parseFloat(canvas.style.width) || 300;
      const cellSize = size / GRID_SIZE;
      const C = getColors();
      ctx.clearRect(0, 0, size, size);
      // —Ñ–æ–Ω —Å–µ—Ç–∫–∏
      ctx.fillStyle = C.FIELD_BG;
      ctx.fillRect(0, 0, size, size);
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          let x = col * cellSize;
          let y = row * cellSize;
          ctx.fillStyle = selectedCell && selectedCell.row === row && selectedCell.col === col ? C.SELECT_BG : C.CELL_BG;
          ctx.fillRect(x, y, cellSize, cellSize);
          ctx.strokeStyle = C.CELL_BORDER;
          ctx.lineWidth = 1.2;
          ctx.strokeRect(x, y, cellSize, cellSize);
        }
      }
    }

    function getCellByCoords(evt) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (evt.touches && evt.touches.length) {
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      } else {
        clientX = evt.clientX;
        clientY = evt.clientY;
      }
      let x = clientX - rect.left;
      let y = clientY - rect.top;
      const cellSize = rect.width / GRID_SIZE;

      const col = Math.floor(x / cellSize);
      const row = Math.floor(y / cellSize);

      if (col < 0 || row < 0 || col >= GRID_SIZE || row >= GRID_SIZE) {
        return null;
      }
      return { row, col };
    }

    function handleClick(evt) {
      const cell = getCellByCoords(evt);
      selectedCell = cell;
      drawGrid();
    }

    canvas.addEventListener('click', handleClick);
    canvas.addEventListener('touchstart', (evt) => {
      evt.preventDefault();
      handleClick(evt);
    });

    // Resize logic
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 100));

    // Theme redraw on change
    const obs = new MutationObserver(() => drawGrid());
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

    setTimeout(resizeCanvas, 0);
    setTimeout(resizeCanvas, 200);
  </script>
</body>
</html>
