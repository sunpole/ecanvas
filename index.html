<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Game Grid Test</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #23272e;
      color: #fff;
      font-family: sans-serif;
      overscroll-behavior: none;
    }
    body, .main-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100dvh;
      height: 100dvh;
      width: 100vw;
      box-sizing: border-box;
      /* fallback для старых браузеров */
    }
    .main-wrapper {
      flex: 1;
      min-height: 0;
      height: 100dvh;
      width: 100vw;
    }
    .top-panel {
      min-height: 48px;
      padding: 12px 0;
      background: #181b21;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bottom-panel {
      min-height: 90px;
      padding: 12px 0;
      background: #181b21;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      /* Учёт безопасной зоны снизу для современных телефонов! */
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    .game-field-container {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      min-width: 0;
    }
    canvas {
      display: block;
      background: #353c48;
      box-shadow: 0 2px 12px #0008;
      touch-action: manipulation;
      border-radius: 8px;
      max-width: 98vw;
      max-height: 98vw;
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="top-panel">Инфо-панель</div>
    <div class="game-field-container">
      <canvas id="game-canvas"></canvas>
    </div>
    <div class="bottom-panel">Навигация/кнопки v1.0.7</div>
  </div>
  <script>
    const GRID_SIZE = 10;
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let selectedCell = null;

    function log(...args) { if (window && window.console) console.log(...args); }

    // Высота панели определяется динамически (safe-area-helper)
    function resizeCanvas() {
      const mainWrap = document.querySelector('.main-wrapper');
      const w = window.innerWidth;

      // Высота именно ДИНАМИЧЕСКОГО вьюпорта:
      // (в современных браузерах и при PWA это будет реальная видимая область)
      const h = mainWrap ? mainWrap.clientHeight : window.innerHeight;

      // Точные размеры панелей
      const topPanel = document.querySelector('.top-panel');
      const bottomPanel = document.querySelector('.bottom-panel');
      const topH = topPanel ? topPanel.getBoundingClientRect().height : 0;
      const bottomH = bottomPanel ? bottomPanel.getBoundingClientRect().height : 0;

      // Главное: Канвас не должен вылезать за пределы между панелями!
      let size = Math.min(
        Math.floor(h - topH - bottomH),
        Math.floor(w * 0.98)
      );
      size = Math.max(size, 200);

      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';

      const dpr = window.devicePixelRatio || 1;
      canvas.width = size * dpr;
      canvas.height = size * dpr;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(dpr, dpr);

      drawGrid();
      log("[resizeCanvas]", { w, h, size, dpr, topH, bottomH });
    }

    function drawGrid() {
      const size = parseFloat(canvas.style.width) || 300;
      ctx.clearRect(0, 0, size, size);
      const cellSize = size / GRID_SIZE;

      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          let x = col * cellSize;
          let y = row * cellSize;
          ctx.fillStyle = selectedCell && selectedCell.row === row && selectedCell.col === col ? "#6488f0" : "#353c48";
          ctx.fillRect(x, y, cellSize, cellSize);
          ctx.strokeStyle = "#23272e";
          ctx.lineWidth = 1.2;
          ctx.strokeRect(x, y, cellSize, cellSize);
        }
      }
    }

    function getCellByCoords(evt) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (evt.touches && evt.touches.length) {
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      } else {
        clientX = evt.clientX;
        clientY = evt.clientY;
      }
      let x = clientX - rect.left;
      let y = clientY - rect.top;
      const cellSize = rect.width / GRID_SIZE;

      log("[getCellByCoords]", { clientX, clientY, rect: {...rect}, x, y, cellSize });

      const col = Math.floor(x / cellSize);
      const row = Math.floor(y / cellSize);

      if (col < 0 || row < 0 || col >= GRID_SIZE || row >= GRID_SIZE) {
        log("Клик вне сетки!", { row, col, x, y });
        return null;
      }

      log("Определена ячейка", { row, col });
      return { row, col };
    }

    function handleClick(evt) {
      const cell = getCellByCoords(evt);
      selectedCell = cell;
      drawGrid();
      if (cell) {
        log(`Выбрана клетка: [${cell.row}, ${cell.col}]`);
      }
    }

    canvas.addEventListener('click', handleClick);
    canvas.addEventListener('touchstart', (evt) => {
      evt.preventDefault();
      handleClick(evt);
    });

    // Ресайз на изменение видимой зоны
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 200));

    // Инициализация
    setTimeout(resizeCanvas, 0);
    // Иногда мобильные браузеры меняют высоту с задержкой после загрузки!
    setTimeout(resizeCanvas, 500);

  </script>
</body>
</html>
