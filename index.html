<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Game Grid Test</title>
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #23272e;
      color: #fff;
      font-family: sans-serif;
      overscroll-behavior: none;
    }
    body, .main-wrapper {
      height: 100dvh;
      width: 100vw;
      min-height: 100dvh;
      min-width: 100vw;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    .main-wrapper {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
      min-width: 0;
      height: 100dvh;
      width: 100vw;
    }

    .top-panel,
    .bottom-panel {
      background: #181b21;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      z-index: 1;
      border-radius: 0;
      box-sizing: border-box;
    }
    .top-panel {
      min-height: 48px;
      padding: 12px 0 12px env(safe-area-inset-left,0), 12px 0 12px env(safe-area-inset-right,0);
      border-top-left-radius: 0.7rem;
      border-top-right-radius: 0.7rem;
      margin-bottom: 0;
    }
    .bottom-panel {
      min-height: 90px;
      padding: 12px 0 env(safe-area-inset-bottom, 0) 0;
      border-bottom-left-radius: 0.7rem;
      border-bottom-right-radius: 0.7rem;
      margin-top: 0;
    }

    .game-field-container {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      min-width: 0;
      position: relative;
    }
    canvas {
      display: block;
      background: #353c48;
      box-shadow: 0 2px 12px #0008;
      touch-action: manipulation;
      border-radius: 8px;
      margin-left: auto;
      margin-right: auto;
      margin-top: 0;
      margin-bottom: 0;
      max-width: 92vw;     /* <-- безопасно! */
      max-height: 70vh;
      width: 100%;
      height: auto;
      box-sizing: border-box;
      /* на максимальную доступную высоту */
    }

    /*==================== Альбомная (горизонтальная) ориентация ====================*/
    @media (orientation: landscape) and (max-width: 1024px) {
      body, .main-wrapper {
        flex-direction: row;
      }
      .main-wrapper {
        flex-direction: row;
        align-items: stretch;
      }
      .top-panel, .bottom-panel {
        width: 56px;
        min-width: 56px;
        max-width: 22vw;
        min-height: 0;
        height: auto;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1;
        border-radius: 0.7rem;
      }
      .top-panel {
        writing-mode: vertical-lr;
        border-top-left-radius: 0.7rem;
        border-bottom-left-radius: 0.7rem;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        margin: 0;
        padding: env(safe-area-inset-top,0) 0 0 env(safe-area-inset-left,0);
      }
      .bottom-panel {
        writing-mode: vertical-lr;
        border-top-right-radius: 0.7rem;
        border-bottom-right-radius: 0.7rem;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        margin: 0;
        padding: 0 0 0 env(safe-area-inset-right,0);
      }
      .game-field-container {
        flex: 1 1 auto;
        min-height: 0;
        min-width: 0;
        max-height: 92vh;    /* безопасная зона! */
        align-items: center;
        justify-content: center;
      }
      canvas {
        max-height: 92vh;   /* больше высоты, но всё равно не до края */
        max-width: 70vw;    /* чтобы не занять весь горизонтальный экран */
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="top-panel">Инфо-панель</div>
    <div class="game-field-container">
      <canvas id="game-canvas"></canvas>
    </div>
    <div class="bottom-panel">Навигация/кнопки v1.1.0</div>
  </div>
  <script>
    const GRID_SIZE = 10;
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let selectedCell = null;

    function isLandscape() {
      return window.matchMedia("(orientation: landscape)").matches;
    }

    function getPanelsSize() {
      const topPanel = document.querySelector('.top-panel');
      const bottomPanel = document.querySelector('.bottom-panel');
      // в портретной ориентации: панели сверху и снизу
      // в альбомной: панели слева и справа (как боковые бары)
      if (!isLandscape()) {
        return {
          main: (topPanel ? topPanel.getBoundingClientRect().height : 0)
              + (bottomPanel ? bottomPanel.getBoundingClientRect().height : 0)
        }
      } else {
        return {
          main: (topPanel ? topPanel.getBoundingClientRect().width : 0)
              + (bottomPanel ? bottomPanel.getBoundingClientRect().width : 0)
        }
      }
    }

    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      const panels = getPanelsSize();
      const isLand = isLandscape();

      // --- размеры canvas (адаптив!) ---
      let maxSize;
      if (!isLand) {
        // портрет — ширина с запасом (не до краёв!)
        maxSize = Math.min(
          Math.floor(h - panels.main),
          Math.floor(w * 0.92)  // 92vw, как в css, для безопасной зоны
        );
      } else {
        // альбомная — высота (+ширина с запасом)
        maxSize = Math.min(
          Math.floor(h * 0.92), // запас сверху/снизу
          Math.floor(w - panels.main)
        );
      }
      maxSize = Math.max(maxSize, 200);

      // --- установка размера ---
      canvas.style.width = maxSize + 'px';
      canvas.style.height = maxSize + 'px';

      const dpr = window.devicePixelRatio || 1;
      canvas.width = maxSize * dpr;
      canvas.height = maxSize * dpr;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(dpr, dpr);

      drawGrid();
    }

    function drawGrid() {
      const size = parseFloat(canvas.style.width) || 300;
      const cellSize = size / GRID_SIZE;

      ctx.clearRect(0, 0, size, size);
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          let x = col * cellSize;
          let y = row * cellSize;
          ctx.fillStyle = selectedCell && selectedCell.row === row && selectedCell.col === col ? "#6488f0" : "#353c48";
          ctx.fillRect(x, y, cellSize, cellSize);
          ctx.strokeStyle = "#23272e";
          ctx.lineWidth = 1.2;
          ctx.strokeRect(x, y, cellSize, cellSize);
        }
      }
    }

    function getCellByCoords(evt) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (evt.touches && evt.touches.length) {
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      } else {
        clientX = evt.clientX;
        clientY = evt.clientY;
      }
      let x = clientX - rect.left;
      let y = clientY - rect.top;
      const cellSize = rect.width / GRID_SIZE;

      const col = Math.floor(x / cellSize);
      const row = Math.floor(y / cellSize);

      if (col < 0 || row < 0 || col >= GRID_SIZE || row >= GRID_SIZE) {
        return null;
      }
      return { row, col };
    }

    function handleClick(evt) {
      const cell = getCellByCoords(evt);
      selectedCell = cell;
      drawGrid();
    }

    canvas.addEventListener('click', handleClick);
    canvas.addEventListener('touchstart', (evt) => {
      evt.preventDefault();
      handleClick(evt);
    });

    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 100));
    setTimeout(resizeCanvas, 0);
    setTimeout(resizeCanvas, 200);

  </script>
</body>
</html>
